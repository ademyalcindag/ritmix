<!DOCTYPE html><html lang="tr"><head>
  <meta charset="utf-8">
  <title>Ritmix – Ruh Hali</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root { --spotify: #1db954; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; }
    body { background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 24px; text-align: center; }
    h1 { font-size: 2rem; margin-bottom: 12px; }
    p { margin-bottom: 24px; color: #b3b3b3; }
    .mood-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; width: 100%; max-width: 480px; }
    .mood-card { background: #181818; border-radius: 12px; padding: 20px; cursor: pointer; transition: .2s; }
    .mood-card:hover { background: #282828; transform: scale(1.03); }
    .mood-card h3 { font-size: 1.1rem; margin-bottom: 4px; }
    .mood-card span { font-size: .8rem; color: #b3b3b3; }
    #log { margin-top: 24px; font-size: .9rem; color: var(--spotify); }
    a { color: var(--spotify); text-decoration: none; font-weight: 600; }
  </style></head><body>
  <h1>Ritmix</h1>
  <p>Ruh haline göre müzik listesi oluştur</p>

  <div class="mood-grid" id="grid"></div>
  <div id="log"></div>

  <script>
    // ✅ KESİN CLIENT ID TANIMI
    const CLIENT_ID = 'c9b9ffada77b4d05b758ca33a2fd43f6';
    const REDIRECT_URI = 'https://ritmix.vercel.app/callback';

    // Token var mı? Yoksa auth flow başlat
    let token = localStorage.getItem('at');
    if (!token) { startAuth(); }

    // PKCE FLOW BAŞLAT
    async function startAuth() {
      const codeVerifier = generateCodeVerifier();
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      localStorage.setItem('cv', codeVerifier);

      // ✅ DÜZELTME 1/3: Auth URL - Spotify'ın Gerçek Auth URL'si
      const authUrl = `https://accounts.spotify.com/api/token5{CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=playlist-modify-public%20playlist-modify-private%20user-top-read&code_challenge=${codeChallenge}&code_challenge_method=S256`;
      window.location = authUrl;
    }

    // CALLBACK’DEN TOKEN AL
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    if (code) {
      exchangeCode(code).then(() => {
        localStorage.removeItem('cv');
        setTimeout(() => { window.location = REDIRECT_URI; }, 500);
      });
    }

    async function exchangeCode(code) {
      const verifier = localStorage.getItem('cv');
      if (!verifier) return;
      
      // ✅ DÜZELTME 2/3: Token Exchange URL - Spotify'ın Gerçek Token URL'si
      const res = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          grant_type: 'authorization_code',
          code: code,
          redirect_uri: REDIRECT_URI,
          client_id: CLIENT_ID, // CLIENT_ID doğru gönderiliyor
          code_verifier: verifier
        })
      });
      const data = await res.json();
      if (data.access_token) {
        localStorage.setItem('at', data.access_token);
        localStorage.setItem('rt', data.refresh_token || '');
      } else {
        console.error('Token alınamadı:', data);
      }
    }

    function generateCodeVerifier() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      return btoa(String.fromCharCode.apply(null, array)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    async function generateCodeChallenge(verifier) {
      const digest = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(verifier));
      return btoa(String.fromCharCode.apply(null, new Uint8Array(digest))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    // RUH HALİ KARTLARI
    const moods = [
      { name: 'Enerjik', desc: 'Hareketli, coşkulu', energy: [0.7, 1], valence: [0.5, 1] },
      { name: 'Sakin', desc: 'Rahat, huzurlu', energy: [0, 0.4], valence: [0.4, 0.8] },
      { name: 'Üzgün', desc: 'Melankolik, derin', energy: [0, 0.5], valence: [0, 0.4] },
      { name: 'Odaklı', desc: 'Dikkat, derinlik', energy: [0.3, 0.7], valence: [0.2, 0.6] },
      { name: 'Neşeli', desc: 'Mutlu, pozitif', energy: [0.5, 1], valence: [0.7, 1] }
    ];

    const grid = document.getElementById('grid');
    moods.forEach(m => {
      const card = document.createElement('div');
      card.className = 'mood-card';
      card.innerHTML = `<h3>${m.name}</h3><span>${m.desc}</span>`; 
      card.onclick = () => createPlaylist(m);
      grid.appendChild(card);
    });
    document.getElementById('log').innerText = '✔ Giriş başarılı, seçim yapın.';

    async function createPlaylist(mood) {
      document.getElementById('log').innerText = 'Liste oluşturuluyor...';
      const user = await api('v1/me');
      
      if (!user.id) {
          document.getElementById('log').innerText = '❌ Kullanıcı bilgisi alınamadı, yetkilendirme sorun olabilir.';
          return;
      }
      
      const playlist = await api(`v1/users/${user.id}/playlists`, 'POST', {
        name: `Ritmix • ${mood.name}`,
        description: 'AI ile ruh haline göre oluşturuldu',
        public: true
      });
      
      if (!playlist.id) {
          document.getElementById('log').innerText = '❌ Liste oluşturulamadı, API hatası devam ediyor.';
          return;
      }
      
      const tracks = await api(`v1/recommendations?limit=20&seed_genres=pop&min_energy=${mood.energy[0]}&max_energy=${mood.energy[1]}&min_valence=${mood.valence[0]}&max_valence=${mood.valence[1]}`);
      
       if (!tracks.tracks) {
          document.getElementById('log').innerText = '❌ Şarkı önerisi alınamadı.';
          return;
      }
      
      const uris = tracks.tracks.map(t => t.uri);
      await api(`v1/playlists/${playlist.id}/tracks`, 'POST', { uris });
      const playlistId = playlist.id;
      
      // Liste başarılı, Oynatıcıyı sayfaya gömüyoruz
      document.getElementById('grid').innerHTML = `
          <iframe 
              style="border-radius:12px