<!DOCTYPE html><html lang="tr"><head>
  <meta charset="utf-8">
  <title>Ritmix – Ruh Hali</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root { --spotify: #1db954; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; }
    body { background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 24px; text-align: center; }
    h1 { font-size: 2rem; margin-bottom: 12px; }
    p { margin-bottom: 24px; color: #b3b3b3; }
    .mood-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; width: 100%; max-width: 480px; }
    .mood-card { background: #181818; border-radius: 12px; padding: 20px; cursor: pointer; transition: .2s; }
    .mood-card:hover { background: #282828; transform: scale(1.03); }
    .mood-card h3 { font-size: 1.1rem; margin-bottom: 4px; }
    .mood-card span { font-size: .8rem; color: #b3b3b3; }
    #log { margin-top: 24px; font-size: .9rem; color: var(--spotify); }
    a { color: var(--spotify); text-decoration: none; font-weight: 600; }
  </style></head><body>
  <h1>Ritmix</h1>
  <p>Ruh haline göre müzik listesi oluştur</p>

  <div class="mood-grid" id="grid"></div>
  <div id="log"></div>

  <script>
    // YENİ AKIŞ: IMPLICIT GRANT FLOW
    const CLIENT_ID = 'c9b9ffada77b4d05b758ca33a2fd43f6';
    
    // Token'ı URL'nin hash (fragment) kısmından doğrudan alıyoruz.
    const params = new URLSearchParams(window.location.hash.substring(1));
    const token = params.get('access_token');

    if (token) {
        localStorage.setItem('at', token);
        // Token'ı aldıktan sonra URL'yi temizle, böylece tekrar yetkilendirme akışı başlamaz.
        window.history.pushState('', document.title, window.location.pathname);
    }

    let currentToken = localStorage.getItem('at');
    if (!currentToken) {
        document.getElementById('log').innerText = '❌ Yetkilendirme başarısız veya token süresi dolmuş. Lütfen ana sayfadan tekrar giriş yapın.';
    } else {
        document.getElementById('log').innerText = '✔ Giriş başarılı, seçim yapın.';
    }
    
    // RUH HALİ KARTLARI
    const moods = [
      { name: 'Enerjik', desc: 'Hareketli, coşkulu', energy: [0.7, 1], valence: [0.5, 1] },
      { name: 'Sakin', desc: 'Rahat, huzurlu', energy: [0, 0.4], valence: [0.4, 0.8] },
      { name: 'Üzgün', desc: 'Melankolik, derin', energy: [0, 0.5], valence: [0, 0.4] },
      { name: 'Odaklı', desc: 'Dikkat, derinlik', energy: [0.3, 0.7], valence: [0.2, 0.6] },
      { name: 'Neşeli', desc: 'Mutlu, pozitif', energy: [0.5, 1], valence: [0.7, 1] }
    ];

    const grid = document.getElementById('grid');
    moods.forEach(m => {
      const card = document.createElement('div');
      card.className = 'mood-card';
      card.innerHTML = `<h3>${m.name}</h3><span>${m.desc}</span>`; 
      // Token varsa liste oluştur, yoksa uyarı ver.
      card.onclick = () => currentToken ? createPlaylist(m) : alert('Lütfen önce Spotify ile giriş yapın.');
      grid.appendChild(card);
    });

    async function createPlaylist(mood) {
      document.getElementById('log').innerText = 'Liste oluşturuluyor...';
      const user = await api('v1/me');
      
      if (!user.id) {
          // Eğer API'den 401 (Unauthorized) dönerse buraya düşer
          document.getElementById('log').innerText = '❌ Kullanıcı bilgisi alınamadı, token süresi dolmuş olabilir.';
          return;
      }
      
      const playlist = await api(`v1/users/${user.id}/playlists`, 'POST', {
        name: `Ritmix • ${mood.name}`,
        description: 'Implicit Flow ile oluşturuldu',
        public: true
      });
      
      if (!playlist.id) {
          document.getElementById('log').innerText = '❌ Liste oluşturulamadı, API hatası devam ediyor.';
          return;
      }
      
      const tracks = await api(`v1/recommendations?limit=20&seed_genres=pop&min_energy=${mood.energy[0]}&max_energy=${mood.energy[1]}&min_valence=${mood.valence[0]}&max_valence=${mood.valence[1]}`);
      
       if (!tracks.tracks) {
          document.getElementById('log').innerText = '❌ Şarkı önerisi alınamadı.';
          return;
      }
      
      const uris = tracks.tracks.map(t => t.uri);
      await api(`v1/playlists/${playlist.id}/tracks`, 'POST', { uris });
      const playlistId = playlist.id;
      
      // Liste başarılı, Oynatıcıyı sayfaya gömüyoruz
      document.getElementById('grid').innerHTML = `
          <iframe 
              style="border-radius:12px" 
              src="https://accounts.spotify.com/api/token3${playlistId}" 
              width="100%" 
              height="352" 
              frameborder="0" 
              allowfullscreen="" 
              allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
              loading="lazy">
          </iframe>
      `;
      document.getElementById('log').innerHTML = `<strong>Liste hazır!</strong><br>Sayfadan ayrılmadan dinleyebilirsiniz.`;
    }

    async function api(endpoint, method = 'GET', body = null) {
      // ✅ API URL'si
      const API_URL = 'https://api.spotify.com/'; 
      
      const res = await fetch(`${API_URL}${endpoint}`, {
        method,
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('at')}`,
          'Content-Type': 'application/json'
        },
        body: body ? JSON.stringify(body) : undefined
      });
      
      if (!res.ok) {
        const errorText = await res.text();
        console.error(`API hatası [${res.status}]:`, errorText);
        return {}; 
      }
      return res.json();
    }
  </script></body></html>