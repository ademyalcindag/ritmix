<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Ritmix - Ruh Hali</title>
    <style>/* önceki css aynı*/</style>
  </head>
  <body>
    <h1>Ruh Halini Seç</h1>
    <div id="buttons"></div>
    <div id="log"></div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      if (!code) { alert('Kod yok'); window.location = '/'; }

      const clientId = 'c9b9ffada77b4d05b758ca33a2fd43f6';
      const redirectUri = 'https://ademyalcindag.github.io/ritmix/callback';

      async function getToken() {
        document.getElementById('log').innerText = 'Token alınıyor...';
        const res = await fetch('https://ritmix.vercel.app/api/token', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({code, redirect_uri: redirectUri})
        });
        const data = await res.json();
        if (data.error) { alert('Token hatası: ' + data.error); return; }
        window.accessToken = data.access_token;
        window.refreshToken = data.refresh_token;
        localStorage.setItem('rt', data.refresh_token);
        document.getElementById('log').innerText = '✔ Giriş başarılı, butonlar aktif!';
        createButtons();
      }

      function createButtons() {
        const moods = [
          {name:'Enerjik', energy:[0.7,1.0], valence:[0.5,1.0]},
          {name:'Sakin',   energy:[0.0,0.4], valence:[0.4,0.8]},
          {name:'Üzgün',   energy:[0.0,0.5], valence:[0.0,0.4]},
          {name:'Odaklı', energy:[0.3,0.7], valence:[0.2,0.6]},
          {name:'Neşeli',  energy:[0.5,1.0], valence:[0.7,1.0]}
        ];
        const box = document.getElementById('buttons');
        moods.forEach(m => {
          const btn = document.createElement('button');
          btn.textContent = m.name;
          btn.onclick = () => createPlaylist(m);
          box.appendChild(btn);
        });
      }

      async function createPlaylist(mood) {
        document.getElementById('log').innerText = 'Çalma listesi oluşturuluyor...';
        const user = await api('v1/me');
        const playlist = await api(`v1/users/${user.id}/playlists`, 'POST', {
          name: `Ritmix • ${mood.name}`,
          description: 'AI ile ruh haline göre oluşturuldu',
          public: true
        });
        const tracks = await api(`v1/recommendations?limit=20&seed_genres=pop&min_energy=${mood.energy[0]}&max_energy=${mood.energy[1]}&min_valence=${mood.valence[0]}&max_valence=${mood.valence[1]}`);
        const uris = tracks.tracks.map(t => t.uri);
        await api(`v1/playlists/${playlist.id}/tracks`, 'POST', {uris});
        document.getElementById('log').innerHTML = `<strong>Liste hazır!</strong><br><a href="${playlist.external_urls.spotify}" target="_blank" style="color:#1db954">Spotify'da aç</a>`;
      }

      async function api(endpoint, method='GET', body=null) {
        const res = await fetch(`https://api.spotify.com/${endpoint}`, {
          method,
          headers: {
            'Authorization': `Bearer ${window.accessToken}`,
            'Content-Type': 'application/json'
          },
          body: body ? JSON.stringify(body) : undefined
        });
        return res.json();
      }

      getToken();
    </script>
  </body>
</html>