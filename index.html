<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <title>Ritmix – Ruh Hali</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        :root { --spotify: #1db954; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; }
        body { background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 24px; text-align: center; }
        h1 { font-size: 2rem; margin-bottom: 12px; }
        p { margin-bottom: 24px; color: #b3b3b3; }
        .mood-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; width: 100%; max-width: 480px; }
        .mood-card { background: #181818; border-radius: 12px; padding: 20px; cursor: pointer; transition: .2s; }
        .mood-card:hover { background: #282828; transform: scale(1.03); }
        .mood-card h3 { font-size: 1.1rem; margin-bottom: 4px; }
        .mood-card span { font-size: .8rem; color: #b3b3b3; }
        #log { margin-top: 24px; font-size: .9rem; color: var(--spotify); }
        a { color: var(--spotify); text-decoration: none; font-weight: 600; }
        #auth-container { margin-top: 20px; }
        .login-btn { background: var(--spotify); color: #fff; padding: 12px 24px; border-radius: 24px; text-decoration: none; display: inline-block; font-weight: bold; }
        #app-container { display: none; } /* Kartları başta gizle */
        #player-container { margin-top: 20px; width: 100%; max-width: 480px; }
    </style>
</head>
<body>
    <h1>Ritmix</h1>

    <div id="auth-container">
        <p>Ruh haline göre müzik listesi oluştur</p>
        <a id="login-btn" class="login-btn" href="#">Spotify ile Giriş</a>
    </div>

    <div id="app-container">
        <div class="mood-grid" id="grid"></div>
        <div id="log"></div>
        <div id="player-container"></div> </div>

    <script>
        // --- MANTIK HATASI DÜZELTİLMİŞ YENİ AKIŞ ---

        const CLIENT_ID = 'c9b9ffada77b4d05b758ca33a2fd43f6';
        const REDIRECT_URI = 'https://ritmix.vercel.app/'; 
        const API_URL = 'https://api.spotify.com/';

        // 1. Token'ı al veya Giriş Linkini Hazırla
        (function handleAuth() {
            console.log('Kimlik doğrulaması kontrol ediliyor...');
            const params = new URLSearchParams(window.location.hash.substring(1));
            const tokenFromUrl = params.get('access_token');

            if (tokenFromUrl) {
                // DURUM 1: Spotify'dan yeni giriş yapıldı (URL'de token var)
                console.log('Token URL hash içinde bulundu:', tokenFromUrl);
                localStorage.setItem('at', tokenFromUrl);
                console.log('Token localStorage\'a kaydedildi.');
                window.history.pushState('', document.title, window.location.pathname); // URL'i temizle
                showApp();
                return;
            }

            // ✅ DÜZELTME: Bu kod bloğu eksikti.
            const tokenFromStorage = localStorage.getItem('at');
            if (tokenFromStorage) {
                // DURUM 2: Sayfa yenilendi (Token depolamada var)
                console.log('Token localStorage\'da bulundu:', tokenFromStorage);
                showApp();
                return;
            }
            
            // DURUM 3: Hiç token yok, giriş yapılmalı
            console.log('Token bulunamadı. Giriş linki hazırlanıyor.');
            const authUrl = `https://api.spotify.com/$0`
            document.getElementById('login-btn').href = authUrl;
        })();

        // 2. Uygulama Arayüzünü Göster
        function showApp() {
            console.log('Uygulama arayüzü gösteriliyor (showApp).');
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('log').innerText = '✔ Giriş başarılı, seçim yapın.';
            
            const moods = [
                { name: 'Enerjik', desc: 'Hareketli, coşkulu', energy: [0.7, 1], valence: [0.5, 1] },
                { name: 'Sakin', desc: 'Rahat, huzurlu', energy: [0, 0.4], valence: [0.4, 0.8] },
                { name: 'Üzgün', desc: 'Melankolik, derin', energy: [0, 0.5], valence: [0, 0.4] },
                { name: 'Odaklı', desc: 'Dikkat, derinlik', energy: [0.3, 0.7], valence: [0.2, 0.6] },
                { name: 'Neşeli', desc: 'Mutlu, pozitif', energy: [0.5, 1], valence: [0.7, 1] }
            ];
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; // Önceki kartları temizle (varsa)
            moods.forEach(m => {
                const card = document.createElement('div');
                card.className = 'mood-card';
                card.innerHTML = `<h3>${m.name}</h3><span>${m.desc}</span>`; 
                card.onclick = () => createPlaylist(m);
                grid.appendChild(card);
            });
        }
        
        // 3. Çalma Listesi Oluştur
        async function createPlaylist(mood) {
            document.getElementById('log').innerText = 'Liste oluşturuluyor...';
            const user = await api('v1/me');
            
            if (!user.id) {
                // API 401 dönerse (api() fonksiyonu içindeki hata yakalama sayesinde) burası tetiklenir
                return;
            }
            
            const playlist = await api(`v1/users/${user.id}/playlists`, 'POST', {
                name: `Ritmix • ${mood.name}`,
                description: 'AI ile ruh haline göre oluşturuldu',
                public: true
            });
            
            if (!playlist.id) {
                document.getElementById('log').innerText = '❌ Liste oluşturulamadı.';
                return;
            }
            
            const tracks = await api(`v1/recommendations?limit=20&seed_genres=pop&min_energy=${mood.energy[0]}&max_energy=${mood.energy[1]}&min_valence=${mood.valence[0]}&max_valence=${mood.valence[1]}`);
            
            if (!tracks.tracks || tracks.tracks.length === 0) {
                document.getElementById('log').innerText = '❌ Bu ruh hali için şarkı bulunamadı.';
                return;
            }
            
            const uris = tracks.tracks.map(t => t.uri);
            await api(`v1/playlists/${playlist.id}/tracks`, 'POST', { uris });
            const playlistId = playlist.id;

            // Kartları ve log'u temizle, oynatıcıyı göster
            document.getElementById('grid').style.display = 'none';
            document.getElementById('log').innerHTML = `<strong>Liste hazır!</strong>`;
            document.getElementById('player-container').innerHTML = `
                <iframe 
                    style="border-radius:12px" 
                    src="https://accounts.spotify.com/api/token3${playlistId}" 
                    width="100%" 
                    height="352" 
                    frameborder="0" 
                    allowfullscreen="" 
                    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                    loading="lazy">
                </iframe>`;
        }

        // 4. API Fonksiyonu
        async function api(endpoint, method = 'GET', body = null) {
            const token = localStorage.getItem('at');
            console.log(`API isteği: ${endpoint}, Token: ${token ? 'Var' : 'Yok'}`);
            
            if (!token) {
                console.log('Token YOK. Giriş sayfasına yönlendiriliyor.');
                window.location = REDIRECT_URI;
                return {};
            }
            
            const res = await fetch(`${API_URL}${endpoint}`, {
                method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: body ? JSON.stringify(body) : undefined
            });
            
            if (!res.ok) {
                if (res.status === 401) { 
                    console.error('API Hatası 401: Token geçersiz veya süresi dolmuş. Giriş sayfasına yönlendiriliyor.');
                    localStorage.removeItem('at'); // Bozuk token'ı sil
                    window.location = REDIRECT_URI; // Ana sayfaya (giriş ekranına) yönlendir
                }
                return {}; // Hata durumunda boş nesne dön
            }
            return res.json();
        }
    </script>
</body>
</html>